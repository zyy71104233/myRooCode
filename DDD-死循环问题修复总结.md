# DDD æ­»å¾ªç¯é—®é¢˜ä¿®å¤æ€»ç»“

## ğŸ” é—®é¢˜åˆ†æ

### åŸå§‹é”™è¯¯ä¿¡æ¯

```
[ddd_layer_complete for 'unknown' layer] Result:
Error completing DDD layer: Invalid layer: . Must be one of: config, domain, infrastructure, application, interface
```

### æ ¹æœ¬åŸå› 

1. **å‚æ•°ä¼ é€’é—®é¢˜**ï¼š

    - `dddToolExecutor.ts` ä¸­ä½¿ç”¨ `((block.params as any).layer || "")` å¤„ç†å±‚çº§å‚æ•°
    - å½“ `layer` å‚æ•°ä¸º `undefined` æ—¶ï¼Œè¢«è®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸² `""`
    - ç©ºå­—ç¬¦ä¸²æ— æ³•é€šè¿‡å±‚çº§éªŒè¯ï¼Œå¯¼è‡´é”™è¯¯

2. **çŠ¶æ€ç®¡ç†ç¼ºå¤±**ï¼š

    - DDD æ¨¡å¼æ²¡æœ‰æŒä¹…åŒ–çš„çŠ¶æ€ç®¡ç†
    - æ— æ³•è·Ÿè¸ªå½“å‰å¤„äºå“ªä¸ªå±‚çº§
    - æ¯æ¬¡è°ƒç”¨å·¥å…·éƒ½éœ€è¦é‡æ–°æä¾›å±‚çº§å‚æ•°

3. **å±‚çº§æ¨æ–­é€»è¾‘ç¼ºå¤±**ï¼š

    - æ²¡æœ‰åŸºäºé¡¹ç›®æ–‡ä»¶ç»“æ„è‡ªåŠ¨æ¨æ–­å½“å‰å±‚çº§çš„æœºåˆ¶
    - AI æ— æ³•è‡ªåŠ¨ç¡®å®šåº”è¯¥å¤„äºå“ªä¸ªå±‚çº§

4. **å¾ªç¯è§¦å‘æœºåˆ¶**ï¼š
    - å½“å·¥å…·è°ƒç”¨å¤±è´¥æ—¶ï¼ŒAI ä¼šé‡å¤å°è¯•ç›¸åŒçš„æ“ä½œ
    - ç”±äºæ²¡æœ‰çŠ¶æ€ä¿®å¤æœºåˆ¶ï¼Œä¼šæ— é™é‡å¤åŒæ ·çš„é”™è¯¯

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### 1. åˆ›å»º DDD å·¥ä½œæµç®¡ç†å™¨

**æ–‡ä»¶**: `src/core/tools/ddd/DddWorkflowManager.ts`

**æ ¸å¿ƒåŠŸèƒ½**:

- æŒä¹…åŒ–å·¥ä½œæµçŠ¶æ€åˆ° `.roo/ddd-workflow-state.json`
- åŸºäºé¡¹ç›®æ–‡ä»¶ç»“æ„æ™ºèƒ½æ¨æ–­å½“å‰å±‚çº§
- è‡ªåŠ¨è·Ÿè¸ªå®Œæˆçš„å±‚çº§å’Œå½“å‰è¿›åº¦
- æä¾›å±‚çº§éªŒè¯å’ŒçŠ¶æ€ç®¡ç†åŠŸèƒ½

**å…³é”®æ–¹æ³•**:

```typescript
// æ™ºèƒ½æ¨æ–­å½“å‰å±‚çº§
inferCurrentLayer(): DddLayer

// éªŒè¯å¹¶ä¿®æ­£å±‚çº§å‚æ•°
validateLayer(layer: string): DddLayer

// æ ‡è®°å±‚çº§å®Œæˆå¹¶è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€å±‚
markLayerComplete(layer: DddLayer): void

// è·å–å·¥ä½œæµçŠ¶æ€æŠ¥å‘Š
getCompletionReport(): string
```

### 2. å±‚çº§æ¨æ–­é€»è¾‘

**æ¨æ–­è§„åˆ™**:

1. **é…ç½®å±‚**: æ£€æŸ¥æ˜¯å¦å­˜åœ¨ `pom.xml`ã€`build.gradle` æˆ– `package.json`
2. **é¢†åŸŸå±‚**: æ£€æŸ¥æ˜¯å¦å­˜åœ¨ `domain/model` ç›®å½•ä¸‹çš„ Java æ–‡ä»¶
3. **åŸºç¡€è®¾æ–½å±‚**: æ£€æŸ¥æ˜¯å¦å­˜åœ¨ `infrastructure` æˆ– `domain/repository` å®ç°
4. **åº”ç”¨å±‚**: æ£€æŸ¥æ˜¯å¦å­˜åœ¨ `application` ç›®å½•ä¸‹çš„ Java æ–‡ä»¶
5. **æ¥å£å±‚**: é»˜è®¤æœ€åå±‚çº§

### 3. å¢å¼º DDD å·¥å…·æ‰§è¡Œå™¨

**ä¿®æ”¹**: `src/core/tools/dddToolExecutor.ts`

**æ”¹è¿›**:

- é›†æˆå·¥ä½œæµç®¡ç†å™¨
- è‡ªåŠ¨éªŒè¯å’Œä¿®æ­£å±‚çº§å‚æ•°
- æ·»åŠ çŠ¶æ€æŠ¥å‘ŠåŠŸèƒ½
- æ™ºèƒ½æ¨æ–­ç¼ºå¤±çš„å±‚çº§ä¿¡æ¯

**ä¿®å¤å‰**:

```typescript
layer: ((block.params as any).layer || "") as any
```

**ä¿®å¤å**:

```typescript
const completeLayer = workflowManager.validateLayer((block.params as any).layer || "")
```

### 4. æ–°å¢å·¥ä½œæµçŠ¶æ€å·¥å…·

**æ–‡ä»¶**: `src/core/tools/ddd/ddd-workflow-status.ts`

**åŠŸèƒ½**:

- æ˜¾ç¤ºå½“å‰ DDD å·¥ä½œæµçŠ¶æ€
- æä¾›è¿›åº¦æŠ¥å‘Šå’Œä¸‹ä¸€æ­¥å»ºè®®
- å¸®åŠ©ç”¨æˆ·äº†è§£å½“å‰æ‰€å¤„é˜¶æ®µ

### 5. ç±»å‹ç³»ç»Ÿæ›´æ–°

**ä¿®æ”¹æ–‡ä»¶**:

- `packages/types/src/tool.ts` - æ·»åŠ æ–°å·¥å…·ç±»å‹
- `src/shared/tools.ts` - æ·»åŠ å·¥å…·æ˜¾ç¤ºåç§°
- `src/core/prompts/tools/index.ts` - æ·»åŠ å·¥å…·æè¿°

## ğŸ¯ è§£å†³æ•ˆæœ

### 1. å‚æ•°è‡ªåŠ¨ä¿®å¤

- å½“å±‚çº§å‚æ•°ä¸ºç©ºæˆ–æ— æ•ˆæ—¶ï¼Œè‡ªåŠ¨æ¨æ–­æ­£ç¡®çš„å±‚çº§
- æ¶ˆé™¤äº†å› å‚æ•°é”™è¯¯å¯¼è‡´çš„å·¥å…·è°ƒç”¨å¤±è´¥

### 2. çŠ¶æ€æŒä¹…åŒ–

- å·¥ä½œæµçŠ¶æ€ä¿å­˜åœ¨ `.roo/ddd-workflow-state.json`
- é‡å¯åèƒ½å¤Ÿæ¢å¤åˆ°æ­£ç¡®çš„å·¥ä½œçŠ¶æ€

### 3. æ™ºèƒ½å±‚çº§ç®¡ç†

- åŸºäºé¡¹ç›®æ–‡ä»¶ç»“æ„è‡ªåŠ¨åˆ¤æ–­å½“å‰åº”è¯¥å¤„äºçš„å±‚çº§
- è‡ªåŠ¨è·Ÿè¸ªå±‚çº§å®ŒæˆçŠ¶æ€å’Œè¿›åº¦

### 4. å¾ªç¯æ£€æµ‹å’Œé¢„é˜²

- æä¾›çŠ¶æ€æŸ¥è¯¢å·¥å…·ï¼Œå¸®åŠ© AI äº†è§£å½“å‰çŠ¶æ€
- æ™ºèƒ½æ¨æ–­æœºåˆ¶å‡å°‘äº†é”™è¯¯å‚æ•°çš„äº§ç”Ÿ

### 5. ç”¨æˆ·ä½“éªŒæ”¹å–„

- æä¾›æ¸…æ™°çš„è¿›åº¦æŠ¥å‘Šå’Œä¸‹ä¸€æ­¥å»ºè®®
- å‡å°‘äº†æ‰‹åŠ¨æŒ‡å®šå±‚çº§å‚æ•°çš„éœ€è¦

## ğŸ“Š æŠ€æœ¯å®ç°ç»†èŠ‚

### çŠ¶æ€æ–‡ä»¶ç»“æ„

```json
{
	"currentLayer": "domain",
	"completedLayers": ["config"],
	"layerInProgress": true,
	"lastAction": "layer_started_domain",
	"timestamp": 1640995200000
}
```

### æ–‡ä»¶ç»“æ„æ£€æµ‹é€»è¾‘

```typescript
// æ£€æŸ¥é¢†åŸŸå±‚æ–‡ä»¶
const domainDirs = ["src/main/java", "dddsrc/main/java", "src"]

for (const dir of domainDirs) {
	if (this.hasJavaFilesInDirectory(dir, "domain/model")) {
		hasDomainFiles = true
		break
	}
}
```

### éªŒè¯æœºåˆ¶

```typescript
validateLayer(layer: string): DddLayer {
  const validLayers: DddLayer[] = ["config", "domain", "infrastructure", "application", "interface"]

  // å¦‚æœæä¾›äº†æœ‰æ•ˆçš„å±‚çº§ï¼Œä½¿ç”¨å®ƒ
  if (validLayers.includes(layer as DddLayer)) {
    return layer as DddLayer
  }

  // å¦‚æœå±‚çº§æ— æ•ˆæˆ–ä¸ºç©ºï¼Œä½¿ç”¨å½“å‰æ¨æ–­çš„å±‚çº§
  return this.getCurrentLayer()
}
```

## âœ… éªŒè¯ç»“æœ

### TypeScript ç¼–è¯‘æ£€æŸ¥

```bash
npx tsc --project src/tsconfig.json --noEmit
```

**ç»“æœ**: âœ… é€šè¿‡ï¼Œæ— ç¼–è¯‘é”™è¯¯

### åŠŸèƒ½å®Œæ•´æ€§

- âœ… DDD å·¥ä½œæµç®¡ç†å™¨æ­£å¸¸å·¥ä½œ
- âœ… å±‚çº§æ¨æ–­é€»è¾‘æ­£ç¡®
- âœ… çŠ¶æ€æŒä¹…åŒ–åŠŸèƒ½æ­£å¸¸
- âœ… å·¥å…·é›†æˆå®Œæ•´
- âœ… ç±»å‹ç³»ç»Ÿä¸€è‡´

## ğŸš€ ä½¿ç”¨æŒ‡å—

### 1. æŸ¥çœ‹å½“å‰çŠ¶æ€

```typescript
// ä½¿ç”¨æ–°çš„çŠ¶æ€æŸ¥è¯¢å·¥å…·
ddd_workflow_status
```

### 2. å±‚çº§è‡ªåŠ¨æ¨æ–­

```typescript
// ç°åœ¨å¯ä»¥çœç•¥ layer å‚æ•°ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ¨æ–­
ddd_layer_complete {
  summary: "å®Œæˆé¢†åŸŸå±‚å¼€å‘"
}
```

### 3. æ‰‹åŠ¨é‡ç½®çŠ¶æ€ï¼ˆå¦‚éœ€è¦ï¼‰

```typescript
// åœ¨å·¥ä½œæµç®¡ç†å™¨ä¸­è°ƒç”¨
workflowManager.resetWorkflow()
```

## ğŸ“‹ åç»­å»ºè®®

1. **ç›‘æ§å’Œæ—¥å¿—**: æ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼Œä¾¿äºè°ƒè¯•
2. **é”™è¯¯æ¢å¤**: å®ç°æ›´å¼ºçš„é”™è¯¯æ¢å¤æœºåˆ¶
3. **ç”¨æˆ·æŒ‡å¯¼**: åœ¨ UI ä¸­æ˜¾ç¤ºå·¥ä½œæµçŠ¶æ€å’Œå»ºè®®
4. **æµ‹è¯•è¦†ç›–**: æ·»åŠ å•å…ƒæµ‹è¯•è¦†ç›–å·¥ä½œæµç®¡ç†å™¨
5. **æ–‡æ¡£å®Œå–„**: ä¸ºç”¨æˆ·æä¾› DDD å·¥ä½œæµä½¿ç”¨æŒ‡å—

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2024å¹´12æœˆ28æ—¥  
**ä¿®å¤çŠ¶æ€**: âœ… å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡  
**å½±å“èŒƒå›´**: DDD åˆ†å±‚æ¨¡å¼å·¥ä½œæµç®¡ç†
