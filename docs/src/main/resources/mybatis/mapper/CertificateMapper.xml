<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.certificate.infrastructure.persistence.mybatis.CertificateRepositoryImpl">

    <resultMap id="certificateResultMap" type="com.example.certificate.domain.model.Certificate">
        <id property="id.value" column="id"/>
        <result property="content.value" column="content"/>
        <result property="status" column="status" typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result property="issueDate" column="issue_date"/>
        <result property="expiryDate" column="expiry_date"/>
        <result property="revocationReason" column="revocation_reason"/>
        <result property="revokedAt" column="revoked_at"/>
    </resultMap>

    <select id="findById" resultMap="certificateResultMap">
        SELECT * FROM certificates WHERE id = #{id}
    </select>

    <insert id="save" parameterType="com.example.certificate.domain.model.Certificate">
        INSERT INTO certificates (id, content, status, issue_date, expiry_date, revocation_reason, revoked_at)
        VALUES (#{id.value}, #{content.value}, #{status}, #{issueDate}, #{expiryDate}, #{revocationReason}, #{revokedAt})
        ON CONFLICT (id) DO UPDATE SET
            content = #{content.value},
            status = #{status},
            issue_date = #{issueDate},
            expiry_date = #{expiryDate},
            revocation_reason = #{revocationReason},
            revoked_at = #{revokedAt}
    </insert>
</mapper>