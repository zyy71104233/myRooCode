<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.certificate.infrastructure.persistence.mybatis.DeploymentRepositoryImpl">

    <resultMap id="deploymentResultMap" type="com.example.certificate.domain.model.Deployment">
        <id property="id.value" column="id"/>
        <result property="certificateId.value" column="certificate_id"/>
        <result property="status" column="status" typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result property="deployedAt" column="deployed_at"/>
    </resultMap>

    <select id="findById" resultMap="deploymentResultMap">
        SELECT * FROM deployments WHERE id = #{id}
    </select>

    <insert id="save" parameterType="com.example.certificate.domain.model.Deployment">
        INSERT INTO deployments (id, certificate_id, status, deployed_at)
        VALUES (#{id.value}, #{certificateId.value}, #{status, typeHandler=org.apache.ibatis.type.EnumTypeHandler}, #{deployedAt})
        ON CONFLICT (id) DO UPDATE SET
            certificate_id = #{certificateId.value},
            status = #{status, typeHandler=org.apache.ibatis.type.EnumTypeHandler},
            deployed_at = #{deployedAt}
    </insert>
</mapper>